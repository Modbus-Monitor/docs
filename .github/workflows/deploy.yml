name: Build & Deploy Docs

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  # schedule:
  #   - cron: "0 3 * * *"   # Nightly rebuild at 3 AM UTC (disabled for now)

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ðŸ”¹ Checkout the repository
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ensures full history, required for committing back


      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ðŸ”¹ Set up Python for MkDocs
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1ï¸âƒ£ Install dependencies
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            mkdocs \
            mkdocs-material \
            mkdocs-include-markdown-plugin \
            mkdocs-awesome-pages-plugin \
            mkdocs-autorefs \
            mkdocs-redirects \
            pymdown-extensions

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2ï¸âƒ£ Basic system updates (pandoc/curl no longer needed)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Update system packages
        run: sudo apt-get update

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3ï¸âƒ£ Ensure imported folder exists (no longer auto-importing)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Ensure imported folder exists
        run: |
          mkdir -p docs/imported
          # Keep existing imported files but don't auto-update them
          echo "ðŸ“‚ Imported folder maintained (auto-import disabled)"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3ï¸âƒ£b Auto-import disabled - no longer committing imported files
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Automated import functionality has been removed
      # Existing imported files are preserved but no longer auto-updated

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3ï¸âƒ£c Update version number and build date
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Update version and build date
        run: |
          current_date=$(date -u +'%Y-%m-%d')
          formatted_date=$(date -u +'%B %d, %Y')
          
          if [ -f "docs/_version.yml" ]; then
            # Read current version
            current_version=$(grep -oP 'version: "\K[^"]+' docs/_version.yml | head -1)
            echo "ðŸ“Œ Current version: $current_version"
            
            # Auto-increment patch version (e.g., 1.0.0 -> 1.0.1)
            IFS='.' read -ra VERSION_PARTS <<< "$current_version"
            MAJOR="${VERSION_PARTS[0]}"
            MINOR="${VERSION_PARTS[1]}"
            PATCH="${VERSION_PARTS[2]}"
            NEW_PATCH=$((PATCH + 1))
            new_version="${MAJOR}.${MINOR}.${NEW_PATCH}"
            
            # Update _version.yml
            sed -i "s/version: \"[^\"]*\"/version: \"$new_version\"/" docs/_version.yml
            sed -i "s/build_date: .*/build_date: \"$current_date\"/" docs/_version.yml
            
            # Update mkdocs.yml copyright with new version and date
            sed -i "s/Documentation Version [0-9]\+\.[0-9]\+\.[0-9]\+/Documentation Version $new_version/" mkdocs.yml
            sed -i "s/Last Updated: [^â€¢]*/Last Updated: $formatted_date/" mkdocs.yml
            
            echo "âœ… Updated version to: $new_version"
            echo "ðŸ“… Updated build date to: $current_date"
            echo "ðŸ“„ Updated copyright in mkdocs.yml"
          else
            echo "âš ï¸ Version file not found, skipping version update"
          fi
          
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3ï¸âƒ£d Commit version updates back to repo
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Commit version updates
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/_version.yml mkdocs.yml
          if git diff --staged --quiet; then
            echo "No version changes to commit"
          else
            git commit -m "ðŸ”„ Auto-update: version bump and build date [skip ci]"
            git push
            echo "âœ… Committed version updates"
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4ï¸âƒ£ Build the MkDocs site
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build MkDocs site
        run: mkdocs build

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4ï¸âƒ£b PDF generation (disabled for now)
      #     Uncomment later if PDF export is required
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # - name: Generate PDFs for Imported Help pages
      #   run: |
      #     sudo apt-get install -y wkhtmltopdf
      #     mkdir -p site/pdfs
      #     declare -a pages=("xpf-help" "advanced-help" "mapper-help" "android-help")
      #     for page in "${pages[@]}"; do
      #       HTML_PATH="site/imported/${page}/index.html"
      #       PDF_PATH="site/pdfs/${page}.pdf"
      #       if [ -f "$HTML_PATH" ]; then
      #         echo "Generating PDF for ${page}..."
      #         wkhtmltopdf \
      #           --enable-local-file-access \
      #           --quiet \
      #           "file://$(pwd)/$HTML_PATH" \
      #           "$PDF_PATH" || true
      #       else
      #         echo "âš ï¸  Skipping ${page} (missing HTML at $HTML_PATH)"
      #       fi
      #     done
      #     echo "âœ… PDF export complete"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5ï¸âƒ£ Upload for GitHub Pages
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 6ï¸âƒ£ Deploy to GitHub Pages
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
